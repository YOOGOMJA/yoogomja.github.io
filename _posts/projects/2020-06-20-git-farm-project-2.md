---
layout: post
title: "[정원사 프로젝트] 2. 개발 환경 구성과 백엔드 개발하기 (1)"
subtitle: "정원사 프로젝트 회고, 개발 환경 구성과 백엔드 개발하기 : mongoose + github API"
author: "yoogomja"
header-style: text
tags:
    - nodejs
    - project
    - reactjs
    - mongodb
    - gcp
    - docker
    - github
    - study
---

### 프로젝트 회고 글타래 

- [1. 토이 프로젝트 기획과 기술 정하기](https://yoogomja.github.io/2020/06/19/git-farm-project-1/)
- [2. 개발 환경 구성과 백엔드 개발하기(1) : mongoose + github API](https://yoogomja.github.io/2020/06/20/git-farm-project-2/)
- ~~3. 백엔드 개발하기 (2) : passport + scheduler~~
- ~~4. 프론트 개발하기 (1) : react + typescript~~
- ~~5. 프론트 개발하기 (2) : react-redux + react-thunk~~
- ~~6. 리팩토링하기~~
- ~~7. 정리~~

# 1. 설계하기 

본격적으로 프로젝트를 시작하기 전에 대략적인 서비스의 흐름을 결정할 필요가 있었다. 최대한 번거로운 기획 단계는 이번에는 건너뛰어 볼 요량으로 이런 저런 단계를 건너뛰었다. 난 항상 이 단계가 어려워서 그런지 저런 다짐에도 불구하고 꽤 오랜시간이 걸렸다. 

우선 이 프로젝트의 기본 기능은 다음과 같았다. 

> 특정 기간동안 등록된 사용자들의 깃허브 push 내역을 크롤링한 후 매일 출석 여부를 확인할 수 있으며, 그 출석 현황에 대한 통계 자료를 제공할 것

이 밖에도 몇가지 기능이 더 있었으나, 기본적인 골자는 위와 같았다. 저 기본 기능에 더해 내가 보완하려고 했던 내용은 다음과 같았다. 

1. 사용자가 손쉽게 프로젝트에 등록할 수 있을 것
2. 프로젝트를 여러번 수행하고 그 수행 내역을 기록할 것 
3. 사용자의 행동들을 통해 다양한 통계를 작성할 수 있을 것 

먼저 첫번째 항목을 이루기 위해서는 `github REST API`가 어떻게 동작하는 지 알아야 했다. 사용자의 푸시 정보를 어떻게 불러올 수 있는지, 그리고 그 푸시 정보가 어떻게 이루어져 있는지를 알아보는게 가장 핵심이었기 때문이다. 

확인해보니, 저런 푸시 정보는 `event`라는 이름으로 관리되고 있었으며 그 종류가 `PushEvent`, `CreateEvent`등 다양한 종류를 가지고 있다는 걸 알게되었다. (이벤트에 대해서는 뒤에 다시 이야기한다.) 무엇보다 제일 중요한 점은 저 이벤트를 가져오기 위한 주소 형태가 `/users/USER_NAME/events` 형태, 즉, `github` 계정명만 있으면 된다는 것을 알게되었다. 그래서 첫번째 구상은 다음과 같았다. 

1. github 유저 이름을 홈페이지에서 등록 
2. 등록된 이름의 이벤트를 크롤링 
3. 크롤링한 정보를 분석해 통계내기 

이런 흐름으로 작업을 할 예정이었다. 그런데 `github REST API`측에서 사용자 정보에 대해서도 꽤많은 정보들(아바타 이미지 주소, profile 정보 등)을 포함하고 있었기에 등록된 유저 이름을 기준으로 유저 정보 또한 크롤링하기로 하였다. 그 과정에서 등록된 유저 이름이 회원 정보 그자체로 사용되는 것이 더 활용도가 높다고 판단되어, 유저 이름을 홈페이지에서 등록하면 해당 유저의 정보를 크롤링해오고, 그 다음 유저의 이벤트를 크롤링해오는 방식으로 가닥을 잡았다. 

> 첫 기획 당시에는 놓친 부분이 있었는데, 등록의 편의성에만 집중하다보니 생각보다 유저 고유의 권한이 필요한 기능이 많이 생길 수 있다는 걸 예측하지 못했다는 점이다. 이 부분을 놓쳐서 추후에 실제 사용할 동아리원들에게 사용성 테스트를 진행한 후 2주정도 추가 작업을 하게되었었다.

유저 등록과정을 가닥을 잡은 이후에는 이벤트를 좀 더 면밀히 살펴봤다. 이벤트는 위에 언급했듯이 `PushEvent`만이 존재하는 것이 아니었다. 그리고 해당 API에서 제공하는 정보는 **약 90일 간의 정보를 한번에 30개씩 10페이지 정도**의 분량으로 제공한다는 점이었다. 그 이벤트 내용들은 모두 `PushEvent`가 아닐 수도 있으며, 한번의 이벤트에 예상보다 적은 정보가 돌아온 다는 점이 유의사항이었다. `PushEvent`만 가져오는 것이 가능한지 알아봤으나 `REST API`에서는 불가한 것으로 내부적으로 결론을 내렸다. 그래서 이벤트 요청을 최대한 효율적으로 진행해야 했다. 

(이 당시에는)도전 과제가 몇개나 얼마나 실행되고 있을지 모를것으로 예상되었기 때문에, 우선은 첫 요청에는 10페이지 분량의 이벤트를 사용자마다 모두 요청하기로 했다. 그리고 `PushEvent`타입의 이벤트만 데이터베이스에 등록하기로 하였으며, 이 과정에서 이벤트는 고유한 일련번호를 가지고 있으므로 데이터 베이스에서도 그 일련번호를 고유한 키로 사용하도록 그대로 유지했다. 그렇기에 새로운 이벤트를 크롤링한 후 데이터 베이스에 이미 해당 키를 가진 이벤트가 발견될 경우 이벤트 크롤링을 종료하는 방향으로 1차 목표를 정했다.

크롤링의 가닥을 잡고난 후, 이벤트의 내용을 살펴보니 이벤트 자체에도 꽤 많은 정보가 들어있었다. 이벤트의 타입 뿐만아니라, 누가 이벤트를 수행했는지, 언제 했는지, **어떤 저장소에 이벤트가 발생했는지**, **어떤 커밋들이 포함되었는지**등이 그것이었다. 여기서 이벤트가 사용자 정보 뿐만 아니라 저장소 정보, 커밋정보까지도 저장하고 있는다는 것을 알게됐다. 

지금 이렇게 구구절절 `github API`이야기를 하는 과정에서 눈치 챘겠지만, 첫 설계 과정에서 데이터베이스 설계를 염두에 두지 않고 먼저 설계를 하게됐다. 내가 내부적으로 어떤 데이터를 갖고있는지보다, `github`에서 제공하는 정보의 형태가 더 중요하다고 생각했던 탓이다. 그렇기에 최대한 `github REST API`측의 데이터 형태를 따르기로 했고, 실제 데이터베이스 모델도 그 형태를 따라서 작업하게 되었다. 

어찌되었든, 살펴보고 알게된 점은 다음과 같았다.

1. 사용자마다 일어난 이벤트를 최대 300개(30개 * 10페이지)까지 조회할 수 있다. 
2. 기본적으로 누가 발생시킨 이벤트인지, 언제 발생했는지에 대한 정보들을 포함한다.
3. 그외에도 타겟 저장소 정보, 포함된 커밋 정보가 포함된다. 

이런 이유로 데이터 베이스는 `events`, `users`, `repositories`, `commits`정도가 필요하겠다고 가닥을 잡았고, 실제 워크 플로우는 다음과 같을 것으로 예상했다. 

1. 사용자가 홈페이지에 접속해 본인의 github username을 등록
2. 등록 시 username을 기준으로 사용자의 정보, 이벤트를 크롤링
3. 크롤링된 정보에서 저장소 정보, 커밋 정보를 추출해 따로 저장 
4. 특정 시간 간격으로 등록된 모든 사용자의 정보를 새로 크롤링 (단, 중복된 이벤트가 발견 시 해당 사용자 정보 크롤링은 종료)

위에 적은 데이터베이스와 워크플로우를 기준으로 프로젝트를 제작하기로 결정하고, 본격적으로 환경을 구성하기 시작했다. 

# 2. 환경 구성하기 

# 3. 백엔드 개발하기 (1)